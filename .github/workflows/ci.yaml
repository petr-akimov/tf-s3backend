name: terraform

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'run action: apply / destroy'
        required: true
        default: apply
        type: choice
        options: [apply, destroy]

jobs:
  bootstrap:
    name: bootstrap
    runs-on: ubuntu-latest
    outputs:
      access_key_id: ${{ steps.set_outputs.outputs.access_key_id }}
      access_key_secret: ${{ steps.set_outputs.outputs.access_key_secret }}
      bucket: ${{ steps.set_outputs.outputs.bucket }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform init (bootstrap)
        working-directory: ./bootstrap
        env:
          TF_VAR_oauth_token: ${{ secrets.YC_OAUTH_TOKEN }}
          TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
          TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
        run: terraform init -input=false

      - name: Terraform apply (bootstrap)
        id: apply_bootstrap
        working-directory: ./bootstrap
        env:
          TF_VAR_oauth_token: ${{ secrets.YC_OAUTH_TOKEN }}
          TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
          TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
        run: |
          terraform apply -auto-approve -input=false
          terraform output -json > tf_bootstrap_outputs.json

      - name: Read outputs and set job outputs
        id: set_outputs
        working-directory: ./bootstrap
        run: |
          ACCESS_KEY_ID=$(jq -r '.static_access_key_id.value' tf_bootstrap_outputs.json)
          ACCESS_KEY_SECRET=$(jq -r '.static_access_key_secret.value' tf_bootstrap_outputs.json)
          BUCKET=$(jq -r '.bucket.value' tf_bootstrap_outputs.json)
          echo "access_key_id=$ACCESS_KEY_ID" >> $GITHUB_OUTPUT
          echo "access_key_secret=$ACCESS_KEY_SECRET" >> $GITHUB_OUTPUT
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: bootstrap
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Create backend file for prod
        run: |
          cat > prod/backend.tf <<EOF
          terraform {
            backend "s3" {
              endpoint = "https://storage.yandexcloud.net"
              bucket   = "${{ needs.bootstrap.outputs.bucket }}"
              key      = "prod/terraform.tfstate"
              region   = "ru-central1"
              access_key = "${{ needs.bootstrap.outputs.access_key_id }}"
              secret_key = "${{ needs.bootstrap.outputs.access_key_secret }}"
              skip_region_validation = true
              skip_credentials_validation = true
            }
          }
          EOF

      - name: Terraform init (prod)
        working-directory: ./prod
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUB_KEY }}
          TF_VAR_access_key: ${{ needs.bootstrap.outputs.access_key_id }}
          TF_VAR_secret_key: ${{ needs.bootstrap.outputs.access_key_secret }}
          TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
          TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
        run: terraform init -input=false -reconfigure

      - name: Terraform apply (prod)
        if: ${{ github.event.inputs.action == 'apply' }}
        working-directory: ./prod
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUB_KEY }}
          TF_VAR_access_key: ${{ needs.bootstrap.outputs.access_key_id }}
          TF_VAR_secret_key: ${{ needs.bootstrap.outputs.access_key_secret }}
          TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
          TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
        run: terraform apply -auto-approve -input=false

      - name: Terraform destroy (prod)
        if: ${{ github.event.inputs.action == 'destroy' }}
        working-directory: ./prod
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUB_KEY }}
          TF_VAR_access_key: ${{ needs.bootstrap.outputs.access_key_id }}
          TF_VAR_secret_key: ${{ needs.bootstrap.outputs.access_key_secret }}
          TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
          TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
        run: terraform destroy -auto-approve -input=false

  cleanup_bootstrap:
    name: cleanup_bootstrap
    runs-on: ubuntu-latest
    needs: [bootstrap, deploy]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Destroy bootstrap (remove bucket + keys)
        if: ${{ github.event.inputs.action == 'destroy' }}
        working-directory: ./bootstrap
        env:
          TF_VAR_oauth_token: ${{ secrets.YC_OAUTH_TOKEN }}
          TF_VAR_cloud_id: ${{ secrets.YC_CLOUD_ID }}
          TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
        run: terraform destroy -auto-approve -input=false        